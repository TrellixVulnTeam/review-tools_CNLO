= Test --seen-db updated =
Emptying seen.db
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-1.db' --store-db='./tests/test-store-1.db'...
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Revision r12 (i386; channels: stable, candidate, beta)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Revision r13 (amd64; channels: edge)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Revision r14 (i386; channels: edge)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3501-1/
 * https://usn.ubuntu.com/3602-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-1.db' --store-db='./tests/test-store-1.db'...

= Test multiple USNs with --seen-db updated =
Emptying seen.db
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-1.db'...
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r12 (i386; channels: stable, candidate, beta)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r13 (amd64; channels: edge)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r14 (i386; channels: edge)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3501-1/
 * https://usn.ubuntu.com/3602-1/
 * https://usn.ubuntu.com/3606-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-1.db'...

= Test previous USNs not reported with --seen-db updated =
Emptying seen.db
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-2.db'...
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r21 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3606-1

Revision r22 (i386; channels: stable, candidate, beta)
 * libtiff5: 3606-1

Revision r23 (amd64; channels: edge)
 * libtiff5: 3606-1

Revision r24 (i386; channels: edge)
 * libtiff5: 3606-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3606-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-2.db'...

= Test up to date with --seen-db updated =
Emptying seen.db
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-3.db'...

Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-3.db'...

= Test real world =
Emptying seen.db
== one USN affects snap ==
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-1.db' --store-db='./tests/test-store-1.db'...
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Revision r12 (i386; channels: stable, candidate, beta)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Revision r13 (amd64; channels: edge)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Revision r14 (i386; channels: edge)
 * libtiff5: 3602-1
 * libxcursor1: 3501-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3501-1/
 * https://usn.ubuntu.com/3602-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-1.db' --store-db='./tests/test-store-1.db'...

== two USNs affect snap ==
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-1.db'...
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3606-1

Revision r12 (i386; channels: stable, candidate, beta)
 * libtiff5: 3606-1

Revision r13 (amd64; channels: edge)
 * libtiff5: 3606-1

Revision r14 (i386; channels: edge)
 * libtiff5: 3606-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3606-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-1.db'...

== no USNs affect snap (snap updated) ==
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-3.db'...

Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-3.db'...

== two USNs affect snap (snap reverted) ==
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-1.db'...
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r12 (i386; channels: stable, candidate, beta)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r13 (amd64; channels: edge)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r14 (i386; channels: edge)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3501-1/
 * https://usn.ubuntu.com/3602-1/
 * https://usn.ubuntu.com/3606-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-1.db'...

== no USNs affect snap (snap updated again) ==
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-3.db'...

Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-2.db' --store-db='./tests/test-store-3.db'...

= Test --seen-db for ubuntu-budgie-welcome =
Emptying seen.db
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-budgie-1.db' --store-db='./tests/test-store-budgie.db'...
From: Snap Store <noreply@canonical.com>
To: packaging@ubuntubudgie.org, security@ubuntu.com
Subject: ubuntu-budgie-welcome contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: candidate, beta)
 * curl: 3598-1
 * libcurl3-gnutls: 3598-1
 * libicu55: 3610-1
 * libssl1.0.0: 3611-1, 3628-1
 * libtiff5: 3602-1, 3606-1
 * libwayland-client0: 3622-1
 * libwayland-cursor0: 3622-1
 * libwayland-server0: 3622-1

Revision r12 (i386; channels: candidate, beta)
 * curl: 3598-1
 * libcurl3-gnutls: 3598-1
 * libicu55: 3610-1
 * libssl1.0.0: 3611-1, 3628-1
 * libtiff5: 3602-1, 3606-1
 * libwayland-client0: 3622-1
 * libwayland-cursor0: 3622-1
 * libwayland-server0: 3622-1

Revision r43 (i386; channels: stable, stable/ubuntu-18.04)
 * libssl1.0.0: 3628-1

Revision r44 (amd64; channels: stable, stable/ubuntu-18.04)
 * libssl1.0.0: 3628-1

Revision r45 (amd64; channels: edge)
 * libssl1.0.0: 3628-1

Revision r46 (i386; channels: edge)
 * libssl1.0.0: 3628-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3598-1/
 * https://usn.ubuntu.com/3602-1/
 * https://usn.ubuntu.com/3606-1/
 * https://usn.ubuntu.com/3610-1/
 * https://usn.ubuntu.com/3611-1/
 * https://usn.ubuntu.com/3622-1/
 * https://usn.ubuntu.com/3628-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-budgie-2.db' --store-db='./tests/test-store-budgie.db'...
From: Snap Store <noreply@canonical.com>
To: packaging@ubuntubudgie.org, security@ubuntu.com
Subject: ubuntu-budgie-welcome contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: candidate, beta)
 * gir1.2-javascriptcoregtk-4.0: 3635-1
 * gir1.2-webkit2-4.0: 3635-1
 * libjavascriptcoregtk-4.0-18: 3635-1
 * libwebkit2gtk-4.0-37: 3635-1

Revision r12 (i386; channels: candidate, beta)
 * gir1.2-javascriptcoregtk-4.0: 3635-1
 * gir1.2-webkit2-4.0: 3635-1
 * libjavascriptcoregtk-4.0-18: 3635-1
 * libwebkit2gtk-4.0-37: 3635-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3635-1/


= Test --seen-db updated for test-xenial and test-bionic =
Emptying seen.db
Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-os-release.db' --store-db='./tests/test-store-os-release.db'...
From: Snap Store <noreply@canonical.com>
To: foo@example.com, security@ubuntu.com
Subject: test-xenial contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r12 (i386; channels: stable, beta)
 * python-requests: 3790-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3790-1/

From: Snap Store <noreply@canonical.com>
To: foo@example.com, security@ubuntu.com
Subject: test-bionic contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r12 (i386; channels: stable, beta)
 * python-requests: 3790-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3790-1/


Running: snap-updates-available --seen-db='<tmpfile>' --usn-db='./tests/test-usn-os-release.db' --store-db='./tests/test-store-os-release.db'...

Running: snap-updates-available --usn-db='./tests/test-usn-budgie-2.db' --snap='./tests/test-snapcraft-manifest_0_amd64.snap'
{
  "libssl1.0.0": [
    "3611-1",
    "3628-1"
  ],
  "openssl": [
    "3611-1",
    "3628-1"
  ]
}

Running: snap-updates-available --usn-db='./tests/test-usn-core-with-dpkg-list.db' --snap='./tests/test-core_16-2.37.2_amd64.snap'
{
  "libc-bin": [
    "3323-1",
    "3534-1"
  ],
  "multiarch-support": [
    "3323-1",
    "3534-1"
  ]
}

Running: snap-updates-available --with-cves --usn-db='./tests/test-usn-core-with-dpkg-list.db' --snap='./tests/test-core_16-2.37.2_amd64.snap'
{
  "libc-bin": {
    "3323-1": [
      "CVE-2017-1000366"
    ],
    "3534-1": [
      "CVE-2017-1000408",
      "CVE-2017-1000409",
      "CVE-2017-15670",
      "CVE-2017-15804",
      "CVE-2017-16997",
      "CVE-2017-17426",
      "CVE-2018-1000001"
    ]
  },
  "multiarch-support": {
    "3323-1": [
      "CVE-2017-1000366"
    ],
    "3534-1": [
      "CVE-2017-1000408",
      "CVE-2017-1000409",
      "CVE-2017-15670",
      "CVE-2017-15804",
      "CVE-2017-16997",
      "CVE-2017-17426",
      "CVE-2018-1000001"
    ]
  }
}

Running: ./bin/snap-updates-available --usn-db='./tests/test-usn-unittest-1.db' --store-db='./tests/test-store-unittest-bad-1.db'
WARN: 1ad: required field 'revisions' not found
ERROR: Errors encountered when scanning store entries
From: Snap Store <noreply@canonical.com>
To: olivier.tilloy@canonical.com, security@ubuntu.com
Subject: 0ad contains outdated Ubuntu packages

A scan of this snap shows that it was built with packages from the Ubuntu
archive that have since received security updates. The following lists new USNs
for affected binary packages in each snap revision:

Revision r11 (amd64; channels: stable, candidate, beta)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r12 (i386; channels: stable, candidate, beta)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r13 (amd64; channels: edge)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Revision r14 (i386; channels: edge)
 * libtiff5: 3602-1, 3606-1
 * libxcursor1: 3501-1

Simply rebuilding the snap will pull in the new security updates and resolve
this. If your snap also contains vendored code, now might be a good time to
review it for any needed updates.

Thank you for your snap and for attending to this matter.

References:
 * https://usn.ubuntu.com/3501-1/
 * https://usn.ubuntu.com/3602-1/
 * https://usn.ubuntu.com/3606-1/


